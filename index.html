<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Launchpad (Stable)</title>
    
    <!-- 加载库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { ethers } = window;

        // 基础配置
        const FACTORY_ADDRESS = "0x381dd293A5dE117D0466Ab56f8A4af6237CbCf23";
        
        // ABI 定义
        const ERC20_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)",
            "function balanceOf(address) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];
        const FACTORY_ABI = [
            "function createProject(uint256 _startBlock, uint256 _endBlock, address _presaleToken, uint256 _presaleAmount, address _baseToken, uint256 _tokenExchangeRate, address _adminAddress, uint256 _minHeldNum)",
            "function getAllProjectlist() view returns (address[])",
            "function isWhitelisted(address user) view returns (bool)"
        ];
        const PROJECT_ABI = [
            "function product() view returns (uint256, uint256, address, address, uint256, uint256, uint256, uint256, address, uint256)",
            "function setting() view returns (uint256, uint256, bool, bool)",
            "function buyToken(uint256 amount)",
            "function addCandy(uint256 amount)"
        ];

        // 简单组件
        const Button = ({ onClick, disabled, children, className="" }) => (
            <button 
                onClick={onClick} 
                disabled={disabled}
                className={`px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-400 transition ${className}`}
            >
                {children}
            </button>
        );

        function App() {
            const [account, setAccount] = useState("");
            const [provider, setProvider] = useState(null);
            const [signer, setSigner] = useState(null);
            const [isWhitelisted, setIsWhitelisted] = useState(false);
            const [projects, setProjects] = useState([]);
            const [currentBlock, setCurrentBlock] = useState(0);
            const [status, setStatus] = useState(""); // 状态提示
            const [showCreate, setShowCreate] = useState(false);

            // 表单数据
            const [form, setForm] = useState({
                presaleToken: "",
                baseToken: "",
                amount: "",
                rate: "",
                startBlock: "",
                endBlock: ""
            });

            // 初始化连接
            const connect = async () => {
                if (!window.ethereum) return alert("请安装 MetaMask");
                try {
                    const _provider = new ethers.BrowserProvider(window.ethereum);
                    const _signer = await _provider.getSigner();
                    const _addr = await _signer.getAddress();
                    setProvider(_provider);
                    setSigner(_signer);
                    setAccount(_addr);
                    
                    // 检查白名单
                    const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, _provider);
                    const isWhite = await factory.isWhitelisted(_addr);
                    setIsWhitelisted(isWhite);

                    // 获取当前区块
                    const block = await _provider.getBlockNumber();
                    setCurrentBlock(block);
                } catch (e) {
                    alert("连接错误: " + e.message);
                }
            };

            // 获取项目列表
            const loadProjects = async () => {
                if (!provider) return;
                try {
                    const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, provider);
                    const list = await factory.getAllProjectlist();
                    
                    // 获取区块更新
                    const block = await provider.getBlockNumber();
                    setCurrentBlock(block);

                    const data = await Promise.all(list.map(async (addr) => {
                        try {
                            const contract = new ethers.Contract(addr, PROJECT_ABI, provider);
                            const prod = await contract.product();
                            const sett = await contract.setting();
                            
                            // 获取代币信息
                            const pToken = new ethers.Contract(prod[2], ERC20_ABI, provider);
                            const bToken = new ethers.Contract(prod[3], ERC20_ABI, provider);
                            
                            const [pSym, pDec] = await Promise.all([pToken.symbol(), pToken.decimals()]);
                            const [bSym, bDec] = await Promise.all([bToken.symbol(), bToken.decimals()]);
                            
                            // 获取合约库存 (Candy)
                            const balance = await pToken.balanceOf(addr);

                            return {
                                address: addr,
                                start: Number(prod[0]),
                                end: Number(prod[1]),
                                pToken: prod[2],
                                bToken: prod[3],
                                pSym, pDec,
                                bSym, bDec,
                                targetAmount: ethers.formatUnits(prod[4], pDec),
                                soldAmount: ethers.formatUnits(prod[5], pDec),
                                rate: prod[7].toString(),
                                admin: prod[8],
                                paused: sett[2],
                                contractBalance: ethers.formatUnits(balance, pDec),
                                minBuy: ethers.formatUnits(sett[1], bDec)
                            };
                        } catch (e) {
                            console.error(e);
                            return null;
                        }
                    }));
                    setProjects(data.filter(i => i));
                } catch (e) {
                    console.error(e);
                }
            };

            useEffect(() => {
                if (provider) {
                    loadProjects();
                    const timer = setInterval(loadProjects, 15000); // 15秒刷新一次
                    return () => clearInterval(timer);
                }
            }, [provider]);

            // 填充时间
            const fillTime = async () => {
                const b = await provider.getBlockNumber();
                setCurrentBlock(b);
                setForm({
                    ...form,
                    startBlock: (b + 100).toString(), // 缓冲100块
                    endBlock: (b + 7200).toString()   // 持续长一点
                });
            };

            // 创建项目逻辑 (还原为最稳妥的 两步走: 授权 -> 创建)
            const handleCreate = async () => {
                if (!form.presaleToken || !form.baseToken) return alert("请填写完整地址");
                
                try {
                    setStatus("正在准备...");
                    const token = new ethers.Contract(form.presaleToken, ERC20_ABI, signer);
                    const decimals = await token.decimals();
                    const amountWei = ethers.parseUnits(form.amount, decimals);

                    // 1. 检查余额
                    const bal = await token.balanceOf(account);
                    if (bal < amountWei) throw new Error("你的代币余额不足！");

                    // 2. 授权
                    const allow = await token.allowance(account, FACTORY_ADDRESS);
                    if (allow < amountWei) {
                        setStatus("步骤1/2: 请在钱包授权...");
                        const tx1 = await token.approve(FACTORY_ADDRESS, amountWei, { gasLimit: 200000 });
                        await tx1.wait();
                    }

                    // 3. 创建
                    setStatus("步骤2/2: 请确认创建交易...");
                    const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, signer);
                    const tx2 = await factory.createProject(
                        form.startBlock,
                        form.endBlock,
                        form.presaleToken,
                        amountWei,
                        form.baseToken,
                        form.rate,
                        account,
                        0, // minHeld
                        { gasLimit: 8000000 } // 给足Gas
                    );
                    setStatus("交易上链中...");
                    await tx2.wait();
                    
                    setStatus("✅ 创建成功！");
                    setTimeout(() => {
                        setStatus("");
                        setShowCreate(false);
                        loadProjects();
                    }, 2000);

                } catch (e) {
                    setStatus("");
                    alert("失败: " + (e.reason || e.message));
                }
            };

            // 充值 Candy
            const addCandy = async (proj, amount) => {
                try {
                    const wei = ethers.parseUnits(amount, proj.pDec);
                    const token = new ethers.Contract(proj.pToken, ERC20_ABI, signer);
                    const project = new ethers.Contract(proj.address, PROJECT_ABI, signer);

                    // 1. 授权给项目合约
                    setStatus("正在授权充值...");
                    const tx1 = await token.approve(proj.address, wei);
                    await tx1.wait();

                    // 2. 充值
                    setStatus("正在注入代币...");
                    const tx2 = await project.addCandy(wei, { gasLimit: 500000 });
                    await tx2.wait();

                    alert("充值成功！");
                    setStatus("");
                    loadProjects();
                } catch (e) {
                    alert("充值失败: " + e.message);
                    setStatus("");
                }
            };

            // 购买 Token
            const buyToken = async (proj, amount) => {
                try {
                    const wei = ethers.parseUnits(amount, proj.bDec);
                    const token = new ethers.Contract(proj.bToken, ERC20_ABI, signer);
                    const project = new ethers.Contract(proj.address, PROJECT_ABI, signer);

                    // 1. 授权给项目合约
                    setStatus("正在授权购买...");
                    const tx1 = await token.approve(proj.address, wei);
                    await tx1.wait();

                    // 2. 购买
                    setStatus("正在购买...");
                    const tx2 = await project.buyToken(wei, { gasLimit: 2000000 });
                    await tx2.wait();

                    alert("购买成功！");
                    setStatus("");
                    loadProjects();
                } catch (e) {
                    let msg = e.reason || e.message;
                    if (msg.includes("Sold out")) msg = "错误：售罄！(请联系管理员充值)";
                    if (msg.includes("Below min")) msg = `错误：低于最小购买量 (${proj.minBuy})`;
                    alert(msg);
                    setStatus("");
                }
            };

            return (
                <div className="max-w-5xl mx-auto p-6">
                    {/* 顶部栏 */}
                    <div className="flex justify-between items-center mb-8 bg-white p-4 rounded shadow-sm">
                        <h1 className="text-2xl font-bold text-blue-600">Web3 Launchpad <span className="text-sm text-gray-400 font-normal">v1.0 Stable</span></h1>
                        <div className="flex items-center gap-4">
                            {status && <span className="text-blue-500 font-bold animate-pulse">{status}</span>}
                            {account ? (
                                <div className="text-right">
                                    <div className="font-mono bg-gray-100 px-3 py-1 rounded">{account.slice(0,6)}...{account.slice(-4)}</div>
                                    <div className="text-xs text-gray-500 mt-1">当前区块: {currentBlock}</div>
                                </div>
                            ) : (
                                <Button onClick={connect}>连接钱包</Button>
                            )}
                        </div>
                    </div>

                    {/* 管理员创建区 */}
                    {isWhitelisted && (
                        <div className="mb-8">
                            <Button onClick={() => setShowCreate(!showCreate)} className="mb-4 bg-gray-700">
                                {showCreate ? "取消创建" : "+ 创建新项目 (管理员)"}
                            </Button>
                            
                            {showCreate && (
                                <div className="bg-white p-6 rounded shadow border-l-4 border-blue-500">
                                    <div className="flex justify-between mb-4">
                                        <h3 className="font-bold">填写参数</h3>
                                        <button onClick={fillTime} className="text-sm text-blue-500 underline">自动填充测试时间 (当前+100)</button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="block text-xs text-gray-500">预售代币地址 (Sale)</label>
                                            <input className="w-full border p-2 rounded" placeholder="0x..." onChange={e => setForm({...form, presaleToken: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-500">基础代币地址 (USDT)</label>
                                            <input className="w-full border p-2 rounded" placeholder="0x..." onChange={e => setForm({...form, baseToken: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-500">预售总量</label>
                                            <input className="w-full border p-2 rounded" placeholder="10000" onChange={e => setForm({...form, amount: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-500">汇率 (1 Base = ? Token)</label>
                                            <input className="w-full border p-2 rounded" placeholder="100" onChange={e => setForm({...form, rate: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-500">开始区块</label>
                                            <input className="w-full border p-2 rounded" value={form.startBlock} onChange={e => setForm({...form, startBlock: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-500">结束区块</label>
                                            <input className="w-full border p-2 rounded" value={form.endBlock} onChange={e => setForm({...form, endBlock: e.target.value})} />
                                        </div>
                                    </div>
                                    <Button onClick={handleCreate} disabled={!!status}>确认创建</Button>
                                </div>
                            )}
                        </div>
                    )}

                    {/* 项目列表 */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {projects.map(p => (
                            <ProjectItem 
                                key={p.address} 
                                project={p} 
                                account={account}
                                currentBlock={currentBlock}
                                onBuy={(amt) => buyToken(p, amt)}
                                onAddCandy={(amt) => addCandy(p, amt)}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        // 拆分出单个项目组件
        function ProjectItem({ project, account, currentBlock, onBuy, onAddCandy }) {
            const [buyAmt, setBuyAmt] = useState("");
            const [candyAmt, setCandyAmt] = useState("");
            const [isAdminMode, setIsAdminMode] = useState(false);

            const isStarted = currentBlock >= project.start;
            const isEnded = currentBlock > project.end;
            const isMyProject = account && project.admin.toLowerCase() === account.toLowerCase();

            return (
                <div className="bg-white p-5 rounded-lg shadow hover:shadow-md transition">
                    <div className="flex justify-between items-start mb-3">
                        <h3 className="font-bold text-lg">{project.pSym} IDO</h3>
                        <div className="text-right">
                            <span className={`text-xs px-2 py-1 rounded ${project.paused ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                {project.paused ? "暂停" : "进行中"}
                            </span>
                        </div>
                    </div>

                    <div className="space-y-2 text-sm text-gray-600 mb-4">
                        <div className="flex justify-between">
                            <span>价格:</span>
                            <span className="font-bold">1 {project.bSym} = {project.rate} {project.pSym}</span>
                        </div>
                        <div className="flex justify-between">
                            <span>进度:</span>
                            <span>{Number(project.soldAmount).toFixed(2)} / {Number(project.targetAmount).toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between text-xs">
                            <span>库存(Candy):</span>
                            <span className={Number(project.contractBalance) === 0 ? "text-red-500 font-bold" : "text-green-600"}>
                                {project.contractBalance}
                            </span>
                        </div>
                        <div className="flex justify-between text-xs">
                            <span>状态:</span>
                            {isEnded ? "已结束" : isStarted ? "进行中" : `未开始 (还差 ${project.start - currentBlock} 块)`}
                        </div>
                        <div className="text-xs text-red-500">
                            最小起买: {project.minBuy} {project.bSym}
                        </div>
                    </div>

                    {/* 购买区 */}
                    <div className="flex gap-2 mb-2">
                        <input 
                            className="border p-2 rounded w-full text-sm" 
                            placeholder={`购买数量 (${project.bSym})`} 
                            value={buyAmt}
                            onChange={e => setBuyAmt(e.target.value)}
                        />
                        <Button 
                            className="bg-green-600 w-24" 
                            onClick={() => onBuy(buyAmt)}
                            disabled={!isStarted || isEnded}
                        >
                            购买
                        </Button>
                    </div>

                    {/* 管理员充值区 */}
                    {isMyProject && (
                        <div className="mt-4 pt-4 border-t">
                            <button onClick={() => setIsAdminMode(!isAdminMode)} className="text-xs text-blue-500 underline mb-2">
                                {isAdminMode ? "收起管理员面板" : "我是管理员(充值)"}
                            </button>
                            
                            {isAdminMode && (
                                <div className="bg-gray-50 p-2 rounded">
                                    <p className="text-xs text-gray-500 mb-1">补充库存 (防止 Sold Out):</p>
                                    <div className="flex gap-2">
                                        <input 
                                            className="border p-1 rounded w-full text-xs" 
                                            placeholder="数量" 
                                            value={candyAmt}
                                            onChange={e => setCandyAmt(e.target.value)}
                                        />
                                        <Button className="bg-yellow-500 text-xs px-2" onClick={() => onAddCandy(candyAmt)}>
                                            充值
                                        </Button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>