<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Launchpad</title>
    
    <!-- åŠ è½½ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- åŠ è½½ React å’Œ ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- åŠ è½½ Babel ç”¨äºè§£æ JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- æ ¸å¿ƒä¿®å¤ï¼šé€šè¿‡ CDN åŠ è½½ Ethers.js (v6) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* çŠ¶æ€æ¡åŠ¨ç”» */
        @keyframes pulse-blue {
            0%, 100% { background-color: #e0f2fe; }
            50% { background-color: #bae6fd; }
        }
        .status-active { animation: pulse-blue 2s infinite; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { ethers } = window;

        // --- 0. å›¾æ ‡ç»„ä»¶ ---
        const WalletIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h2v-4Z"/></svg>
        );
        const CoinsIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></svg>
        );
        const PlayIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>
        );
        const RefreshIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        );
        const CheckCircleIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        );
        const LoaderIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`animate-spin ${className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        );

        // --- 1. é…ç½®ä¸ ABI ---
        const FACTORY_ADDRESS = "0x381dd293A5dE117D0466Ab56f8A4af6237CbCf23";

        const ERC20_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)",
            "function balanceOf(address) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        const FACTORY_ABI = [
            "function createProject(uint256 _startBlock, uint256 _endBlock, address _presaleToken, uint256 _presaleAmount, address _baseToken, uint256 _tokenExchangeRate, address _adminAddress, uint256 _minHeldNum)",
            "function getAllProjectlist() view returns (address[])",
            "function isWhitelisted(address user) view returns (bool)",
            "event ProjectCreated(address indexed project, address indexed presaleToken, address indexed baseToken)"
        ];

        const PROJECT_ABI = [
            "function product() view returns (uint256, uint256, address, address, uint256, uint256, uint256, uint256, address, uint256)",
            "function setting() view returns (uint256, uint256, bool, bool)",
            "function buyToken(uint256 amount)",
            "function addCandy(uint256 amount)"
        ];

        // --- 2. è¾…åŠ©ç»„ä»¶ ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-md border border-gray-100 p-6 ${className}`}>
                {children}
            </div>
        );

        const Button = ({ onClick, disabled, children, variant = "primary", className = "" }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300",
                secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200 disabled:bg-gray-100",
                outline: "border border-gray-300 text-gray-700 hover:bg-gray-50",
                success: "bg-green-600 text-white hover:bg-green-700"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        // --- 3. ä¸»åº”ç”¨ ---
        function LaunchpadApp() {
            const [account, setAccount] = useState("");
            const [provider, setProvider] = useState(null);
            const [signer, setSigner] = useState(null);
            const [isWhitelisted, setIsWhitelisted] = useState(false);
            const [projects, setProjects] = useState([]);
            const [loading, setLoading] = useState(false);
            const [showCreateForm, setShowCreateForm] = useState(false);
            const [currentBlock, setCurrentBlock] = useState(0);
            const [statusMsg, setStatusMsg] = useState(""); 
            const [refreshTrigger, setRefreshTrigger] = useState(0); // ç”¨äºè§¦å‘ä½™é¢åˆ·æ–°
            
            const [formData, setFormData] = useState({
                presaleToken: "",
                baseToken: "",
                presaleAmount: "",
                tokenDecimals: "18", 
                exchangeRate: "",
                startBlock: "",
                endBlock: "",
                minHeld: "0"
            });

            const connectWallet = async () => {
                if (window.ethereum) {
                    try {
                        const _provider = new ethers.BrowserProvider(window.ethereum);
                        const _signer = await _provider.getSigner();
                        const _account = await _signer.getAddress();
                        
                        setProvider(_provider);
                        setSigner(_signer);
                        setAccount(_account);
                        
                        const block = await _provider.getBlockNumber();
                        setCurrentBlock(block);
                        console.log("å½“å‰åŒºå—é«˜åº¦:", block);

                        checkWhitelist(_account, _provider);
                    } catch (err) {
                        console.error("è¿æ¥è¿‡ç¨‹å‡ºé”™:", err);
                        alert("è¿æ¥é’±åŒ…å¤±è´¥: " + err.message);
                    }
                } else {
                    alert("è¯·å®‰è£… MetaMask!");
                }
            };

            const checkWhitelist = async (userAddress, providerInstance) => {
                try {
                    const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, providerInstance);
                    const status = await factory.isWhitelisted(userAddress);
                    setIsWhitelisted(status);
                } catch (err) {
                    console.error("æ£€æŸ¥ç™½åå•å¤±è´¥", err);
                }
            };

            // æ•°æ®è·å–
            const fetchProjects = async () => {
                if (!provider) return;
                setLoading(true);
                try {
                    const block = await provider.getBlockNumber();
                    setCurrentBlock(block);

                    const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, provider);
                    const projectAddresses = await factory.getAllProjectlist();
                    
                    const projectDataPromises = projectAddresses.map(async (addr) => {
                        try {
                            const projectContract = new ethers.Contract(addr, PROJECT_ABI, provider);
                            const product = await projectContract.product();
                            const setting = await projectContract.setting();
                            
                            // è·å–ä»£å¸ç¬¦å·
                            let tokenSymbol = "TOKEN";
                            let presaleDecimals = 18;
                            try {
                                const tokenContract = new ethers.Contract(product[2], ERC20_ABI, provider);
                                tokenSymbol = await tokenContract.symbol();
                                presaleDecimals = Number(await tokenContract.decimals());
                            } catch (e) {}

                            // è·å– Base Token ç²¾åº¦
                            let baseDecimals = 18;
                            let baseSymbol = "BASE";
                            try {
                                const baseTokenContract = new ethers.Contract(product[3], ERC20_ABI, provider);
                                baseDecimals = Number(await baseTokenContract.decimals());
                                baseSymbol = await baseTokenContract.symbol();
                            } catch(e) {}

                            return {
                                address: addr,
                                startBlock: product[0].toString(),
                                endBlock: product[1].toString(),
                                presaleToken: product[2],
                                baseToken: product[3],
                                presaleAmount: ethers.formatUnits(product[4], presaleDecimals),
                                saleAmount: ethers.formatUnits(product[5], presaleDecimals),
                                exchangeRate: product[7].toString(),
                                admin: product[8],
                                paused: setting[2],
                                tokenSymbol,
                                baseSymbol,
                                baseDecimals, 
                                presaleDecimals,
                                minPerBuy: setting[1], 
                                maxBuy: setting[0]     
                            };
                        } catch (err) {
                            console.error(`è·å–é¡¹ç›® ${addr} è¯¦æƒ…å¤±è´¥`, err);
                            return null;
                        }
                    });

                    const results = await Promise.all(projectDataPromises);
                    setProjects(results.filter(p => p !== null));
                } catch (err) {
                    console.error("è·å–é¡¹ç›®åˆ—è¡¨å¤±è´¥", err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (provider) {
                    fetchProjects();
                    const interval = setInterval(async () => {
                        try {
                            const block = await provider.getBlockNumber();
                            setCurrentBlock(block);
                        } catch(e) {}
                    }, 15000); 
                    return () => clearInterval(interval);
                }
            }, [provider, refreshTrigger]);

            const autofillBlocks = async () => {
                if (!provider) return;
                const block = await provider.getBlockNumber();
                setCurrentBlock(block);
                
                const buffer = 200; 
                const duration = 7200; 
                const start = block + buffer; 
                const end = start + duration;
                
                setFormData({
                    ...formData,
                    startBlock: start.toString(),
                    endBlock: end.toString()
                });
            };

            const handleCreateProject = async () => {
                if (!signer) return;
                try {
                    setStatusMsg("ğŸ” æ­£åœ¨æ£€æŸ¥åŒºå—é«˜åº¦...");
                    const latestBlock = await provider.getBlockNumber();
                    let finalStartBlock = BigInt(formData.startBlock);
                    let finalEndBlock = BigInt(formData.endBlock);

                    if (finalStartBlock <= BigInt(latestBlock) + 50n) {
                        const safeStart = BigInt(latestBlock) + 200n; 
                        const safeEnd = safeStart + 7200n;
                        const confirmFix = confirm(`âš ï¸ å¼€å§‹æ—¶é—´å¯èƒ½å·²è¿‡æœŸï¼\n\nå»ºè®®è‡ªåŠ¨ä¿®æ­£ä¸ºï¼š\næœ€æ–°åŒºå— + 200 (çº¦å‡ åˆ†é’Ÿåå¼€å§‹)`);
                        if (!confirmFix) {
                            setStatusMsg("");
                            return;
                        }
                        finalStartBlock = safeStart;
                        finalEndBlock = safeEnd;
                        setFormData({...formData, startBlock: safeStart.toString(), endBlock: safeEnd.toString()});
                    }

                    const decimals = parseInt(formData.tokenDecimals || "18");
                    const amountWei = ethers.parseUnits(formData.presaleAmount, decimals);

                    setStatusMsg("ğŸ’° æ­£åœ¨æ£€æŸ¥ä»£å¸ä½™é¢...");
                    const presaleTokenContract = new ethers.Contract(formData.presaleToken, ERC20_ABI, signer);
                    const balance = await presaleTokenContract.balanceOf(account);
                    
                    if (balance < amountWei) {
                        setStatusMsg("âŒ ä½™é¢ä¸è¶³");
                        throw new Error(`TRANSFER_EXCEEDS_BALANCE: æ‚¨çš„ä½™é¢ä¸è¶³ï¼\nå½“å‰ä½™é¢: ${ethers.formatUnits(balance, decimals)}`);
                    }

                    setStatusMsg("ğŸ” æ­£åœ¨æ£€æŸ¥æˆæƒ...");
                    const currentAllowance = await presaleTokenContract.allowance(account, FACTORY_ADDRESS);
                    
                    if (currentAllowance < amountWei) {
                        setStatusMsg("ğŸ‘‰ è¯·åœ¨é’±åŒ…ä¸­ç‚¹å‡»ã€æ‰¹å‡†/Approveã€‘...");
                        const approveTx = await presaleTokenContract.approve(FACTORY_ADDRESS, amountWei, { gasLimit: 200000 });
                        
                        setStatusMsg("â³ æˆæƒäº¤æ˜“ä¸Šé“¾ä¸­...");
                        await approveTx.wait();
                    } else {
                        console.log("å·²æˆæƒï¼Œè·³è¿‡");
                    }

                    setStatusMsg("ğŸš€ æˆæƒå®Œæˆï¼è¯·åœ¨é’±åŒ…ä¸­ç‚¹å‡»ã€ç¡®è®¤åˆ›å»ºã€‘...");
                    const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, signer);
                    
                    const tx = await factory.createProject(
                        finalStartBlock,
                        finalEndBlock,
                        formData.presaleToken,
                        amountWei, 
                        formData.baseToken,
                        BigInt(formData.exchangeRate),
                        account,
                        BigInt(formData.minHeld),
                        { gasLimit: 6000000 } 
                    );
                    
                    setStatusMsg("â³ é¡¹ç›®éƒ¨ç½²ä¸­ï¼Œè¯·ç¨å€™...");
                    await tx.wait();
                    
                    setStatusMsg("âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸï¼æ­£åœ¨åˆ·æ–°...");
                    setTimeout(() => {
                        setShowCreateForm(false);
                        setStatusMsg("");
                        fetchProjects();
                    }, 2000);

                } catch (err) {
                    console.error(err);
                    setStatusMsg("âŒ æ“ä½œå¤±è´¥");
                    let errMsg = err.reason || err.message || JSON.stringify(err);
                    alert(errMsg); 
                }
            };

            const ProjectCard = ({ project, currentBlock }) => {
                const [buyAmount, setBuyAmount] = useState("");
                const [buying, setBuying] = useState(false);
                const [userBalance, setUserBalance] = useState("0");

                const startBlock = parseInt(project.startBlock);
                const endBlock = parseInt(project.endBlock);
                const isStarted = currentBlock >= startBlock;
                const isEnded = currentBlock > endBlock;
                const blocksToStart = startBlock - currentBlock;

                const minBuyReadable = ethers.formatUnits(project.minPerBuy, project.baseDecimals);
                const maxBuyReadable = ethers.formatUnits(project.maxBuy, project.baseDecimals);

                const fetchBalance = useCallback(async () => {
                    if (account && project.baseToken && provider) {
                        try {
                            const tokenContract = new ethers.Contract(project.baseToken, ERC20_ABI, provider);
                            const bal = await tokenContract.balanceOf(account);
                            setUserBalance(ethers.formatUnits(bal, project.baseDecimals));
                        } catch(e) { console.error("Balance error", e); }
                    }
                }, [account, project.baseToken, project.baseDecimals]);

                useEffect(() => {
                    fetchBalance();
                }, [fetchBalance, refreshTrigger]); // ä¾èµ– refreshTrigger æ¥å¼ºåˆ¶åˆ·æ–°ä½™é¢

                const handleBuy = async () => {
                    if (!signer) return alert("è¯·å…ˆè¿æ¥é’±åŒ…");
                    
                    if (parseFloat(buyAmount) < parseFloat(minBuyReadable)) {
                        return alert(`è´­ä¹°æ•°é‡ä¸èƒ½ä½äºæœ€å°é™é¢: ${minBuyReadable} ${project.baseSymbol}\nï¼ˆè¿™æ˜¯åˆçº¦ç¡¬æ€§è§„å®šçš„ï¼Œä¹°å¤ªå°‘ä¼šæŠ¥é”™ï¼‰`);
                    }

                    setBuying(true);
                    try {
                        const projectContract = new ethers.Contract(project.address, PROJECT_ABI, signer);
                        const baseTokenContract = new ethers.Contract(project.baseToken, ERC20_ABI, signer);
                        
                        const amountWei = ethers.parseUnits(buyAmount, project.baseDecimals);

                        console.log("Approving...");
                        setStatusMsg(`æ­¥éª¤1/2: æ­£åœ¨æˆæƒ ${buyAmount} ${project.baseSymbol}...`);
                        const approveTx = await baseTokenContract.approve(project.address, amountWei);
                        await approveTx.wait();
                        
                        console.log("Buying...");
                        setStatusMsg(`æ­¥éª¤2/2: æ­£åœ¨è´­ä¹°...`);
                        const buyTx = await projectContract.buyToken(amountWei);
                        await buyTx.wait();
                        
                        alert(`ğŸ‰ è´­ä¹°æˆåŠŸï¼\næ¶ˆè€—: ${buyAmount} ${project.baseSymbol}`);
                        
                        // å¼ºåˆ¶åˆ·æ–°æ•´ä¸ªåˆ—è¡¨å’Œä½™é¢
                        setStatusMsg("åˆ·æ–°æ•°æ®ä¸­...");
                        setRefreshTrigger(prev => prev + 1); // è§¦å‘ä½™é¢åˆ·æ–°
                        fetchProjects();
                    } catch (err) {
                        console.error(err);
                        setStatusMsg(""); // æ¸…é™¤çŠ¶æ€
                        let msg = err.reason || err.message || JSON.stringify(err);
                        if (msg.includes("Not started")) msg = "é”™è¯¯ï¼šé¡¹ç›®å°šæœªå¼€å§‹ï¼è¯·ç­‰å¾…å¼€å§‹åŒºå—ã€‚";
                        if (msg.includes("Ended")) msg = "é”™è¯¯ï¼šé¡¹ç›®å·²ç»“æŸï¼";
                        if (msg.includes("exceeds balance")) msg = "é”™è¯¯ï¼šæ‚¨çš„åŸºç¡€ä»£å¸ä½™é¢ä¸è¶³ï¼";
                        if (msg.includes("Below min")) msg = `é”™è¯¯ï¼šè´­ä¹°æ•°é‡ä½äºæœ€å°é™é¢ (${minBuyReadable} ${project.baseSymbol})ï¼`;
                        alert(msg);
                    } finally {
                        setBuying(false);
                        setStatusMsg("");
                    }
                };

                const progress = project.presaleAmount > 0 
                    ? (Number(project.saleAmount) / Number(project.presaleAmount)) * 100 
                    : 0;

                return (
                    <Card className="hover:shadow-lg transition-shadow border-t-4 border-t-blue-500">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h3 className="text-xl font-bold text-gray-800">{project.tokenSymbol} IDO</h3>
                                <p className="text-xs text-gray-500 font-mono mt-1">åˆçº¦: {project.address.slice(0,6)}...{project.address.slice(-4)}</p>
                            </div>
                            <div className="flex flex-col items-end gap-1">
                                <span className={`px-2 py-1 rounded text-xs font-bold ${project.paused ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                    {project.paused ? 'æš‚åœä¸­' : 'è¿›è¡Œä¸­'}
                                </span>
                                {!isStarted && (
                                    <span className="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs">
                                        â³ æœªå¼€å§‹ ({blocksToStart}å—)
                                    </span>
                                )}
                                {isEnded && (
                                    <span className="bg-gray-200 text-gray-600 px-2 py-0.5 rounded text-xs">
                                        ğŸ å·²ç»“æŸ
                                    </span>
                                )}
                            </div>
                        </div>

                        <div className="space-y-3 mb-6">
                            <div className="flex justify-between text-sm bg-blue-50 p-2 rounded">
                                <span className="text-blue-800">1 {project.baseSymbol} = {project.exchangeRate} {project.tokenSymbol}</span>
                            </div>
                            
                            <div className="flex justify-between text-sm">
                                <span className="text-gray-500">è´­ä¹°é™åˆ¶</span>
                                <div className="text-right text-xs">
                                    <span className="block text-red-600 font-bold">Min: {minBuyReadable} {project.baseSymbol}</span>
                                    {maxBuyReadable !== "0.0" && <span className="block">Max: {maxBuyReadable}</span>}
                                </div>
                            </div>
                            <div className="flex justify-between text-sm">
                                <span className="text-gray-500">å‹Ÿé›†è¿›åº¦</span>
                                <span className="font-semibold">{Number(project.saleAmount).toFixed(2)} / {Number(project.presaleAmount).toFixed(2)}</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2.5">
                                <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${Math.min(progress, 100)}%` }}></div>
                            </div>
                        </div>

                        <div className="flex flex-col gap-2">
                            <div className="flex justify-between text-xs text-gray-500">
                                <span>ä½™é¢: {parseFloat(userBalance).toLocaleString()} {project.baseSymbol}</span>
                                <button onClick={fetchBalance} className="text-blue-500 hover:underline">åˆ·æ–°ä½™é¢</button>
                            </div>
                            <div className="flex gap-2">
                                <input 
                                    type="number" 
                                    placeholder={`èµ·ä¹°: ${minBuyReadable}`} 
                                    value={buyAmount}
                                    onChange={(e) => setBuyAmount(e.target.value)}
                                    className="flex-1 border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <Button 
                                    onClick={handleBuy} 
                                    disabled={buying || project.paused || !isStarted || isEnded} 
                                    className={`min-w-[80px] ${!isStarted ? 'opacity-50 cursor-not-allowed' : ''}`}
                                >
                                    {buying ? "å¤„ç†ä¸­" : !isStarted ? "æœªå¼€å§‹" : isEnded ? "å·²ç»“æŸ" : "è´­ä¹°"}
                                </Button>
                            </div>
                        </div>
                    </Card>
                );
            };

            return (
                <div className="max-w-6xl mx-auto p-8 relative">
                    {statusMsg && (
                        <div className="fixed top-0 left-0 w-full bg-blue-600 text-white p-3 text-center shadow-lg z-50 flex items-center justify-center gap-2">
                            <LoaderIcon size={20} className="text-white" />
                            <span className="font-bold">{statusMsg}</span>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-10 mt-8">
                        <div className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                                <CoinsIcon size={24} />
                            </div>
                            <h1 className="text-2xl font-bold tracking-tight">Web3 Launchpad</h1>
                        </div>
                        
                        <div className="flex items-center gap-4">
                            {isWhitelisted && (
                                <span className="flex items-center gap-1 text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full border border-yellow-200">
                                    <CheckCircleIcon size={14} /> ç™½åå•ç”¨æˆ· (Creator)
                                </span>
                            )}
                            
                            {!account ? (
                                <Button onClick={connectWallet}>
                                    <WalletIcon size={18} /> è¿æ¥é’±åŒ…
                                </Button>
                            ) : (
                                <div className="flex items-center gap-2 bg-white border px-4 py-2 rounded-lg">
                                    <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                    <div className="flex flex-col items-end">
                                        <span className="text-sm font-mono text-gray-600">
                                            {account.slice(0, 6)}...{account.slice(-4)}
                                        </span>
                                        <span className="text-xs text-blue-500">åŒºå—: {currentBlock}</span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="space-y-8">
                        {account && isWhitelisted && (
                            <section>
                                <div className="flex justify-between items-end mb-4">
                                    <h2 className="text-xl font-bold text-gray-800">é¡¹ç›®ç®¡ç† (Admin)</h2>
                                    <Button variant="outline" onClick={() => setShowCreateForm(!showCreateForm)}>
                                        {showCreateForm ? 'å–æ¶ˆåˆ›å»º' : <span><span className="inline-block mr-1 text-lg leading-none align-middle">+</span>åˆ›å»ºæ–°é¡¹ç›®</span>}
                                    </Button>
                                </div>
                                
                                {showCreateForm && (
                                    <Card className="mb-8 border-blue-200 ring-4 ring-blue-50/50">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold text-lg">é…ç½®æ–° IDO é¡¹ç›®</h3>
                                            <button 
                                                onClick={autofillBlocks}
                                                className="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded hover:bg-indigo-200"
                                            >
                                                âœ¨ ä¸€é”®å¡«å…… (ç¼“å†²+200å—)
                                            </button>
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm text-gray-600 mb-1">é¢„å”®ä»£å¸åœ°å€ (Presale Token)</label>
                                                <input className="w-full border p-2 rounded" placeholder="ä¾‹å¦‚: 0x... (ä½ å–çš„å¸)" 
                                                    onChange={e => setFormData({...formData, presaleToken: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-600 mb-1">åŸºç¡€ä»£å¸åœ°å€ (USDT/Base)</label>
                                                <input className="w-full border p-2 rounded" placeholder="ä¾‹å¦‚: 0x... (æ”¯ä»˜ç”¨çš„å¸)" 
                                                    onChange={e => setFormData({...formData, baseToken: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-600 mb-1">é¢„å”®æ€»æ•°é‡</label>
                                                <input type="number" className="w-full border p-2 rounded" placeholder="100000" 
                                                    onChange={e => setFormData({...formData, presaleAmount: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-600 mb-1">ä»£å¸ç²¾åº¦ (Decimals)</label>
                                                <select className="w-full border p-2 rounded bg-white" 
                                                    value={formData.tokenDecimals}
                                                    onChange={e => setFormData({...formData, tokenDecimals: e.target.value})}>
                                                    <option value="18">18 (æ ‡å‡†ERC20)</option>
                                                    <option value="6">6 (USDT/USDC)</option>
                                                    <option value="8">8 (WBTC)</option>
                                                </select>
                                                <p className="text-xs text-gray-400 mt-1">æ³¨æ„ï¼šå¦‚æœä¸çŸ¥é“è¯·ä¿æŒ18ã€‚USDTæ˜¯6ã€‚</p>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-600 mb-1">æ±‡ç‡ (1 Base = ? Token)</label>
                                                <input type="number" className="w-full border p-2 rounded" placeholder="100" 
                                                    onChange={e => setFormData({...formData, exchangeRate: e.target.value})} />
                                            </div>
                                            <div className="bg-gray-50 p-2 rounded">
                                                <label className="block text-sm text-gray-600 mb-1">å¼€å§‹åŒºå— (Start Block)</label>
                                                <input type="number" className="w-full border p-2 rounded bg-white" 
                                                    placeholder={`å¿…é¡» > ${currentBlock}`}
                                                    value={formData.startBlock}
                                                    onChange={e => setFormData({...formData, startBlock: e.target.value})} />
                                                <p className={`text-xs mt-1 ${parseInt(formData.startBlock) <= currentBlock ? 'text-red-500 font-bold' : 'text-gray-400'}`}>
                                                    å½“å‰é«˜åº¦: {currentBlock} (ç›¸å·®: {parseInt(formData.startBlock || 0) - currentBlock})
                                                </p>
                                            </div>
                                            <div className="bg-gray-50 p-2 rounded">
                                                <label className="block text-sm text-gray-600 mb-1">ç»“æŸåŒºå— (End Block)</label>
                                                <input type="number" className="w-full border p-2 rounded bg-white" 
                                                    placeholder={`å»ºè®®: ${currentBlock + 7200}`}
                                                    value={formData.endBlock}
                                                    onChange={e => setFormData({...formData, endBlock: e.target.value})} />
                                            </div>
                                        </div>
                                        <div className="mt-6 flex justify-end">
                                            <Button onClick={handleCreateProject} disabled={!!statusMsg}>
                                                {statusMsg ? "æ“ä½œè¿›è¡Œä¸­..." : "ç¡®è®¤éƒ¨ç½²ä¸Šé“¾"}
                                            </Button>
                                        </div>
                                    </Card>
                                )}
                            </section>
                        )}

                        <section>
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <PlayIcon size={20} className="text-blue-500" />
                                    æ­£åœ¨è¿›è¡Œçš„ IDO
                                </h2>
                                <Button variant="secondary" onClick={fetchProjects} className="text-sm">
                                    <RefreshIcon size={14} className={loading ? "animate-spin" : ""} /> åˆ·æ–°åˆ—è¡¨
                                </Button>
                            </div>

                            {projects.length === 0 ? (
                                <div className="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300">
                                    <p className="text-gray-500">æš‚æ— é¡¹ç›®ï¼Œç­‰å¾…ç®¡ç†å‘˜åˆ›å»º...</p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {projects.map((proj) => (
                                        <ProjectCard key={proj.address} project={proj} currentBlock={currentBlock} />
                                    ))}
                                </div>
                            )}
                        </section>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LaunchpadApp />);
    </script>
</body>
</html>